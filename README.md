# Mrittika

A full‑stack **TypeScript** application for event & registration management, built with **React + TanStack Router**, **Vinxi/Nitro** for the server, **tRPC** for the API, and **Prisma** (PostgreSQL) for data. Designed to deploy on **Vercel** using Nitro’s `vercel` preset.

> This README reflects the exact repo you shared. Commands and folder names below match your project.

---

## Tech Stack

- **UI:** React, TanStack Router, React Hook Form, Zod, Tailwind CSS
- **State/Data:** TanStack Query, tRPC (with `superjson`), JWT auth
- **Server:** Vinxi + Nitro (`/api/*` handlers, `/trpc` endpoint)
- **Database:** Prisma ORM + PostgreSQL
- **Tooling:** Vite, ESLint, Prettier, TypeScript
- **Deployment:** Vercel (Build Output API via Nitro preset)
- **Extras:** Client console forwarding to server (`/api/debug/client-logs`), minimal MinIO client stub for expense receipts

---

## Project Structure (abridged)

```
./
./app.config.ts
./eslint.config.mjs
./fix-prisma-dotprisma-plugin.ts
./index.html
./nitro.config.ts
./package.json
./postcss.config.mjs
./prettier.config.mjs
./tailwind.config.mjs
./tsconfig.json
./tsr.config.json
./vite-console-forward-plugin.ts
./.codapt/
./.codapt/docs/
./.codapt/scripts/
./.output/
./.output/public/
./.output/public/index.html
./.output/server/
./.output/server/package.json
./.tanstack/
./.tanstack/tmp/
./.vinxi/
./.vinxi/build/
./.vinxi/types/
./.vinxi/types/nitro-config.d.ts
./.vinxi/types/nitro-imports.d.ts
./.vinxi/types/nitro-routes.d.ts
./.vinxi/types/nitro.d.ts
./.vinxi/types/tsconfig.json
./.vscode/
./.vscode/settings.json
./docker/
./docker/nginx/
./prisma/
./prisma/schema.prisma
./prisma/migrations/
./public/
./scripts/
./src/
./src/main.tsx
./src/router.tsx
./src/components/
./src/components/FileDownload.tsx
./src/components/Layout.tsx
./src/generated/
./src/generated/routeTree.gen.ts
./src/routes/
./src/routes/__root.tsx
./src/routes/index.tsx
./src/server/
./src/server/db.ts
./src/server/env.ts
./src/server/minio.ts
./src/stores/
./src/stores/auth.ts
./src/trpc/
./src/trpc/query-client.ts
./src/trpc/react.tsx
```

Key paths:
- `src/routes/**` → file‑based routes (TanStack Router; code‑gen to `src/generated/tanstack-router/routeTree.gen.ts`)
- `src/server/trpc/**` → tRPC router, procedures, and handler (`/trpc`)
- `src/server/utils/**` → auth utilities (JWT, bcrypt hashing), base URL helpers
- `src/server/debug/client-logs-handler.ts` → receives client console logs
- `prisma/schema.prisma` → PostgreSQL schema
- `app.config.ts` → Vinxi app config (client & server build setup)
- `nitro.config.ts` → Nitro config (set `preset: 'vercel'` for Vercel deploy)
- `docker/compose.yaml` → local Postgres/Redis/Adminer (optional dev helpers)

---

## Requirements

- **Node.js 20+**
- **PostgreSQL 14+** (or use `docker/compose.yaml`)
- **pnpm** (recommended) or npm

---

## Quick Start (Local)

1) **Clone & install**  
```bash
pnpm install
# or: npm install
```

2) **Environment variables** – copy `.env` and update as needed:
```ini
NODE_ENV=development
BASE_URL=http://localhost:3000
BASE_URL_OTHER_PORT=http://localhost:3001

ADMIN_PASSWORD=__set_a_strong_admin_password__
JWT_SECRET=__set_a_long_random_secret__

# Postgres connection
DATABASE_URL=postgresql://USER:PASSWORD@HOST:PORT/DB?schema=public
```
Optional MinIO settings are commented in `.env` (the project currently ships a no‑op MinIO client).

3) **Database**  
Create the DB, then run migrations:
```bash
pnpm db:generate   # prisma migrate dev
# (or) pnpm db:push  # for throwaway local dev without migrations
```
Open Prisma Studio if desired:
```bash
pnpm db:studio
```

4) **Dev server**  
```bash
pnpm dev
```
Now visit **http://localhost:3000**.

- Public registration: `/register`, `/member-register`
- Admin pages: `/admin/events`, `/admin/sessions`, `/admin/products`, `/admin/orders`, `/admin/expenses`, `/admin/users`, `/admin/venues`, `/admin/reporting`
- API endpoint: `/trpc`
- Client console forwarding target: `/api/debug/client-logs`

> **Note:** Route types are generated by **TanStack Router** on `postinstall` via `tsr generate` (see `tsr.config.json`).

---

## Build & Run

```bash
pnpm build
pnpm start   # Node server mode
```

For a production preview in Node‑server mode, use `pnpm start` after `pnpm build`.

---

## Deploying to Vercel (recommended)

To avoid “404 at / after deploy”, build using Nitro’s **Vercel preset** so the repo emits `.vercel/output/**` (Vercel Build Output API).

1) **Set presets**  
`app.config.ts`:
```diff
 export default createApp({
   server: {
-    preset: "node-server",
+    preset: "vercel",
   },
   ...
 })
```
`nitro.config.ts`:
```diff
 export default defineNitroConfig({
+  preset: 'vercel',
   externals: { external: ['@prisma/client'] },
 });
```

2) **Vercel project settings**  
- **Build Command:** `pnpm build` (or `npm run build`)  
- **Output Directory:** _leave empty_ (the build will create `.vercel/output`)  
- **Environment Variables:** set `ADMIN_PASSWORD`, `JWT_SECRET`, `DATABASE_URL`, and (optionally) `BASE_URL`.

3) **Deploy** – push to your default branch. Vercel will detect the Build Output and serve both static assets and server routes.

> **Workaround (static‑only):** If you intentionally want a static SPA and no server routes, set Output Directory to `./.output/public`. Your `/trpc` and `/api/*` routes will not work in that mode.

---

## Authentication

- **Login** and **registration** are implemented via tRPC procedures.  
- JWTs are signed with `JWT_SECRET` and validated in `src/server/utils/auth.ts`.

Default seed data:
- There’s a script at `src/server/scripts/setup.ts` intended to create an admin user and a couple of member accounts. It also tries to initialize a MinIO bucket. The shipped MinIO client is a no‑op stub; if you plan to use the setup script, either point it at a real MinIO/S3‑compatible server or skip the bucket step and insert users via Prisma/SQL.

---

## Styling

- Tailwind CSS is configured in `tailwind.config.mjs`.  
- Global styles at `src/styles.css`.

---

## Common Issues & Fixes

### 1) 404 at `/` after a successful Vercel deploy
Ensure both `app.config.ts` and `nitro.config.ts` use **`vercel`** presets so the build emits `.vercel/output/**`.

### 2) Prisma 6 `.prisma` import error during client build
This repo includes a Vite plugin `fix-prisma-dotprisma-plugin.ts` that shims accidental `.prisma` imports in the browser bundle. It’s already enabled in `app.config.ts`.

### 3) Zod env validation failures at runtime
If you see errors for `ADMIN_PASSWORD`, `JWT_SECRET`, or `NODE_ENV`, confirm they exist in the environment where the **server** runs (local shell, Vercel Project Settings, etc.). `DATABASE_URL` is read by Prisma and must be set wherever migrations/queries run.

### 4) Database connectivity
Double‑check `DATABASE_URL` format and that your DB is reachable (network, TLS/sslmode, IP allowlist if using a managed service).

---

## Available Scripts

```jsonc
{
  "postinstall": "prisma generate && tsr generate",
  "dev": "vinxi dev",
  "build": "vinxi build",
  "start": "vinxi start",
  "typecheck": "tsc --noEmit",
  "lint": "eslint . -c eslint.config.mjs --max-warnings 0",
  "db:generate": "prisma migrate dev",
  "db:migrate": "prisma migrate deploy",
  "db:push": "prisma db push",
  "db:studio": "prisma studio",
  "format": "prettier --write ."
}
```

- `postinstall`: Generates the Prisma client and TanStack Router types.  
- `dev`: Starts the Vinxi dev server.  
- `build`: Builds client and server.  
- `start`: Starts the built Node server (useful outside Vercel).  
- `db:*`: Prisma helpers.  
- `lint`, `format`, `typecheck`: Project hygiene.

---

## Contributing

1. Create a feature branch  
2. Keep changes typed and lint‑clean (`pnpm typecheck && pnpm lint`)  
3. Open a PR

---

## License

Proprietary — internal project. Update this section if you decide to open‑source.
